<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGarden è¿ªå£«å°¼ - æ™ºèƒ½æ¶æ„çœ‹æ¿ v2.2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Panzoom åº“ -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <!-- Marked.js ç”¨äºè§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç”»å¸ƒèƒŒæ™¯ */
        .canvas-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* å®¹å™¨æ ·å¼ */
        .diagram-container {
            width: 100%;
            height: 100%;
            overflow: visible; 
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
        }

        .diagram-container svg {
            max-width: none !important; 
            height: auto !important;
            min-height: 100%;
            overflow: visible !important;
        }

        /* é¢æ¿è¿‡æ¸¡åŠ¨ç”» */
        .panel-slide {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }
        .panel-hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }

        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        .chat-user {
            background-color: #e0e7ff;
            color: #3730a3;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background-color: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e2e8f0;
        }
        .chat-ai pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        /* AIæ€è€ƒåŠ¨ç”» */
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #94a3b8;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-screen overflow-hidden flex">

    <!-- å·¦ä¾§å¯¼èˆª -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-20 shrink-0">
        <div class="p-6 border-b border-slate-700 bg-indigo-600">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-robot"></i>
                iGarden è¿ªå£«å°¼
            </h1>
            <p class="text-xs text-indigo-200 mt-1">æ¶æ„çœ‹æ¿ v2.2 (Logic Upd)</p>
            <p class="text-xs text-indigo-300 mt-2 flex items-center gap-1">
                <i class="fas fa-user-edit"></i> ä½œè€…ï¼šéŸ¦ç¿”æ–Œ
            </p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchTab('hardware')" id="btn-hardware" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors border-l-4 border-transparent flex items-center gap-3">
                <i class="fas fa-microchip w-5 text-center"></i>
                <span>ç¡¬ä»¶æ‹“æ‰‘å›¾</span>
            </button>
            <button onclick="switchTab('software')" id="btn-software" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors border-l-4 border-transparent flex items-center gap-3">
                <i class="fas fa-network-wired w-5 text-center"></i>
                <span>ROS 2 è½¯ä»¶æ¶æ„</span>
            </button>
            <button onclick="switchTab('algorithm')" id="btn-algorithm" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors border-l-4 border-transparent flex items-center gap-3">
                <i class="fas fa-code-branch w-5 text-center"></i>
                <span>çº¢å¤–ç„å‡†ç®—æ³•</span>
            </button>
            <button onclick="switchTab('fsm')" id="btn-fsm" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors border-l-4 border-transparent flex items-center gap-3">
                <i class="fas fa-gamepad w-5 text-center"></i>
                <span>æ¸¸æˆçŠ¶æ€æœº</span>
            </button>
        </nav>
        
        <div class="p-4 bg-slate-800 border-t border-slate-700 space-y-2">
             <button onclick="resetView()" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 rounded text-sm font-medium transition flex items-center justify-center gap-2">
                <i class="fas fa-compress-arrows-alt"></i> é€‚é…å±å¹•
             </button>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="flex-1 flex flex-col relative h-full min-w-0">
        
        <!-- å·¥å…·æ  -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10 shrink-0">
            <div id="header-title" class="text-lg font-semibold text-slate-700">
                ç¡¬ä»¶æ‹“æ‰‘ç»“æ„å›¾
            </div>
            <div class="flex items-center gap-3">
                
                <!-- ç¼©æ”¾æ§åˆ¶ -->
                <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1">
                    <button onclick="zoomOut()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-white rounded transition">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <span id="zoom-level" class="w-12 text-center font-mono text-sm text-slate-600 select-none">--%</span>
                    <button onclick="zoomIn()" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-white rounded transition">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>

                <div class="w-px h-6 bg-slate-300"></div>

                <!-- ç¼–è¾‘å™¨å¼€å…³ -->
                <button onclick="toggleEditor()" id="btn-edit-toggle" class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 hover:border-indigo-500 hover:text-indigo-600 text-slate-700 rounded-lg transition shadow-sm text-sm">
                    <i class="fas fa-edit"></i>
                    <span class="hidden sm:inline">æºç </span>
                </button>

                <!-- AI åŠ©æ‰‹å¼€å…³ -->
                <button onclick="toggleAI()" id="btn-ai-toggle" class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 hover:from-violet-600 hover:to-fuchsia-600 text-white rounded-lg transition shadow-sm text-sm font-medium">
                    <i class="fas fa-sparkles"></i>
                    <span>AI åŠ©æ‰‹</span>
                </button>
            </div>
        </header>

        <!-- ç”»å¸ƒå®¹å™¨ -->
        <div class="flex-1 relative overflow-hidden canvas-bg cursor-move" id="canvas-wrapper">
            <div id="hardware" class="diagram-container"></div>
            <div id="software" class="diagram-container hidden"></div>
            <div id="algorithm" class="diagram-container hidden"></div>
            <div id="fsm" class="diagram-container hidden"></div>
            
            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 pointer-events-none transition-opacity duration-300 opacity-0">
                <div class="flex flex-col items-center">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-3"></i>
                    <p class="text-slate-600 font-medium">æ¸²æŸ“å›¾è¡¨ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- é¢æ¿ï¼šå®æ—¶ä»£ç ç¼–è¾‘å™¨ -->
        <div id="editor-panel" class="panel-slide panel-hidden absolute top-16 right-0 bottom-0 w-1/3 min-w-[350px] bg-white border-l border-slate-200 shadow-2xl flex flex-col z-40">
            <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                    <i class="fas fa-code text-indigo-500"></i> Mermaid æºç 
                </h3>
                <div class="text-xs text-slate-400">Ctrl+S ä¿å­˜</div>
            </div>
            <div class="flex-1 relative">
                <textarea id="code-editor" class="w-full h-full p-4 font-mono text-xs leading-relaxed text-slate-700 bg-slate-50 resize-none outline-none focus:bg-white transition-colors" spellcheck="false"></textarea>
            </div>
            <div class="p-2 bg-slate-100 border-t border-slate-200 text-xs text-slate-500 flex justify-between items-center">
                <span id="editor-status">å°±ç»ª</span>
            </div>
        </div>

        <!-- é¢æ¿ï¼šAI åŠ©æ‰‹ -->
        <div id="ai-panel" class="panel-slide panel-hidden absolute top-16 right-0 bottom-0 w-1/3 min-w-[350px] bg-white border-l border-slate-200 shadow-2xl flex flex-col z-50">
            <div class="p-4 bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold flex items-center gap-2">
                    <i class="fas fa-sparkles"></i> æ¶æ„å¸ˆåŠ©æ‰‹
                </h3>
                <button onclick="toggleAI()" class="hover:bg-white/20 rounded p-1 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                <!-- æ¬¢è¿è¯­ -->
                <div class="chat-bubble chat-ai flex flex-col gap-2">
                    <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ iGarden æœºå™¨äººæ¶æ„åŠ©æ‰‹ã€‚</p>
                    <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                    <ul class="list-disc list-inside text-xs space-y-1 ml-1 text-slate-600">
                        <li>è§£é‡Šå½“å‰æ¶æ„å›¾çš„é€»è¾‘</li>
                        <li>ä¼˜åŒ– Mermaid ä»£ç ç»“æ„</li>
                        <li>ç”Ÿæˆæ–°çš„åŠŸèƒ½æ¨¡å—æµç¨‹å›¾</li>
                    </ul>
                </div>
            </div>

            <!-- å¿«æ·æŒ‡ä»¤ -->
            <div class="px-4 py-2 bg-white border-t border-slate-100 flex gap-2 overflow-x-auto no-scrollbar shrink-0">
                <button onclick="sendQuickAction('explain')" class="whitespace-nowrap px-3 py-1.5 bg-indigo-50 text-indigo-600 text-xs rounded-full hover:bg-indigo-100 transition border border-indigo-100">
                    <i class="fas fa-book-open mr-1"></i> è§£è¯»å½“å‰å›¾
                </button>
                <button onclick="sendQuickAction('optimize')" class="whitespace-nowrap px-3 py-1.5 bg-emerald-50 text-emerald-600 text-xs rounded-full hover:bg-emerald-100 transition border border-emerald-100">
                    <i class="fas fa-magic mr-1"></i> ä¼˜åŒ–å¸ƒå±€
                </button>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                <div class="relative">
                    <textarea id="ai-input" rows="1" class="w-full pl-4 pr-12 py-3 bg-slate-100 border-0 rounded-xl focus:ring-2 focus:ring-violet-500 focus:bg-white resize-none text-sm transition" placeholder="è¾“å…¥éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š'æ·»åŠ ä¸€ä¸ªä½ç”µé‡è¿”èˆªçš„çŠ¶æ€'..." onkeydown="handleInputKey(event)"></textarea>
                    <button onclick="sendMessage()" id="btn-send" class="absolute right-2 bottom-2 p-1.5 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <div class="text-[10px] text-center text-slate-400 mt-2">Powered by Gemini 2.5 Flash</div>
            </div>
        </div>

    </main>

    <script>
        const apiKey = ""; // Runtime Environment will inject key

        // åˆå§‹ Mermaid ä»£ç æ•°æ®
        const diagrams = {
            'hardware': `
graph TD
    subgraph Handheld_Controller ["ç©å®¶æ‰‹æŒç«¯ (ESP32)"]
        C_MCU["ESP32 ä¸»æ§"]
        C_Bat["é”‚ç”µæ± ç”µæº"]
        C_UWB["UWB æ ‡ç­¾æ¨¡ç»„"]
        C_IR["çº¢å¤–å‘å°„ç®¡ LED"]
        C_Btn["äº¤äº’æŒ‰é”®"]

        C_Bat --> C_MCU
        C_MCU -->|NEC 10Hz| C_IR
        C_MCU <-->|"UART/SPI"| C_UWB
        C_MCU -->|GPIO| C_Btn
        C_MCU -.->|"BLE å¹¿æ’­"| R_Bluetooth
    end

    subgraph Robot_System ["æœºå™¨äººæœ¬ä½“"]
        
        subgraph Power_System ["ç”µæºç®¡ç†"]
            Bat_Main["åŠ¨åŠ›é”‚ç”µæ±  12V/24V"]
            DC_DC["é™å‹æ¨¡å— 5V/12V"]
        end

        subgraph Upper_Computer ["ä¸Šä½æœº (AIä¸å†³ç­–)"]
            RK3588["RK3588 ä¸»æ§æ¿ <br/> Ubuntu + ROS 2"]
            Cam["USB å¹¿è§’æ‘„åƒå¤´"]
            UWB_Base["UWB åŸºç«™æ¨¡ç»„"]
            Screen_L["1.28å¯¸ åœ†å½¢å± (å·¦çœ¼)"]
            Screen_R["1.28å¯¸ åœ†å½¢å± (å³çœ¼)"]
            Audio["æ‰¬å£°å™¨"]
            IR_Recv["çº¢å¤–æ¥æ”¶å¤´ <br/> (ç›´æ¥GPIOè¿æ¥)"]
            R_Bluetooth["æ¿è½½è“ç‰™"]
        end

        subgraph Lower_Computer ["ä¸‹ä½æœº (è¿åŠ¨æ§åˆ¶)"]
            STM32["STM32 å•ç‰‡æœº"]
            IMU["6è½´ IMU é™€èºä»ª"]
            Motor_Dr["ç”µæœºé©±åŠ¨æ¿"]
            Servo_Lift["å‡é™æœºæ„èˆµæœº/æ¨æ†"]
            LED_Strip["RGB è¡€æ¡ç¯å¸¦"]
            Motors["å…¨å‘è½®ç”µæœº M1-M3/M4"]
        end

        %% è¿æ¥å…³ç³»
        Bat_Main --> DC_DC
        DC_DC --> RK3588
        DC_DC --> STM32
        DC_DC --> Motor_Dr

        Cam ==>|"USB 3.0"| RK3588
        UWB_Base <-->|"USB/UART"| RK3588
        IR_Recv -->|"GPIO (Pythonå¤„ç†)"| RK3588
        RK3588 -->|"SPI/USB"| Screen_L
        RK3588 -->|"SPI/USB"| Screen_R
        RK3588 -->|"I2S/USB"| Audio
        RK3588 <==>|"UART/CAN"| STM32

        STM32 <-->|CAN| IMU
        STM32 -->|PWM| Motor_Dr
        STM32 -->|PWM| Servo_Lift
        STM32 -->|GPIO| LED_Strip
        Motor_Dr --> Motors
    end

    %% æ— çº¿è¿æ¥
    C_UWB -.->|"æ— çº¿æµ‹è· ToF"| UWB_Base
    C_IR -.->|"çº¢å¤–å…‰æŸ NEC"| IR_Recv

    style RK3588 fill:#e0e7ff,stroke:#4338ca,stroke-width:2px
    style STM32 fill:#dbeafe,stroke:#2563eb,stroke-width:2px
            `,
            'software': `
graph TD
    %% å®šä¹‰æ ·å¼
    classDef driver fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef ai fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;
    classDef logic fill:#fff3e0,stroke:#e65100,stroke-width:2px;
    classDef out fill:#e0f2f1,stroke:#004d40,stroke-width:2px;

    %% -------------------
    %% ç¡¬ä»¶æŠ½è±¡ä¸é©±åŠ¨å±‚
    %% -------------------
    subgraph Hardware_Device ["ç¡¬ä»¶å±‚ (Hardware Layer)"]
        HW_Cam([USB æ‘„åƒå¤´])
        HW_UWB([UWB æ¨¡ç»„])
        HW_STM32([STM32 ä¸‹ä½æœº])
        HW_IR_Sensor([çº¢å¤–æ¥æ”¶ç®¡])
        
        %% ç‰©ç†è¿æ¥
        HW_IR_Sensor -.->|GPIOä¸­æ–­| HW_STM32
        style Hardware_Device fill:#fafafa,stroke:#9e9e9e
    end

    subgraph Driver_Layer ["é©±åŠ¨æ¥å…¥å±‚ (Driver Layer)"]
        Node_Cam["ğŸ“· ç›¸æœºé©±åŠ¨<br/>(v4l2_camera)"]:::driver
        Node_UWB["ğŸ“¡ UWB é©±åŠ¨<br/>(Serial Read)"]:::driver
        Node_Bridge["Bridgeæ¡¥æ¥ç‚¹<br/>(STM32)"]:::driver
    end

    %% -------------------
    %% æ„ŸçŸ¥ä¸èåˆå±‚
    %% -------------------
    subgraph Perception_Layer ["æ„ŸçŸ¥ä¸ç®—æ³•å±‚ (Perception Layer)"]
        Node_YOLO["ğŸ§  YOLO è§†è§‰èŠ‚ç‚¹<br/>(RKNN / äººä½“æ£€æµ‹)"]:::ai
        Node_AprilTag["ğŸš© AprilTag/è“ç‰™/UWBèŠ‚ç‚¹<br/>(ç”µå­å›´æ æ£€æµ‹)"]:::ai
        
        %% æ–°å¢ï¼šç›®æ ‡ç­›é€‰é€»è¾‘
        Node_Gating["ğŸ¯ ç›®æ ‡ç­›é€‰ (Target Gating)<br/>(Vis Dist vs UWB Dist)"]:::ai
        
        Node_Fusion["ğŸ“ çŠ¶æ€ä¼°è®¡/èåˆ<br/>(Visual + UWB + Odom)"]:::ai
        Node_IR_Filter["ğŸ›¡ï¸ çº¢å¤–åˆ¤å®šèŠ‚ç‚¹<br/>(æ¼æ¡¶ç®—æ³• Leaky Bucket)"]:::ai
    end

    %% -------------------
    %% å†³ç­–ä¸æ§åˆ¶å±‚
    %% -------------------
    subgraph Decision_Layer ["å†³ç­–æ§åˆ¶å±‚ (Decision Layer)"]
        Node_BT{{"ğŸŒ² è¡Œä¸ºæ ‘æ ¸å¿ƒ<br/>(Behavior Tree)"}}:::logic
        
        %% è¯¦ç»†é€»è¾‘æ¨¡å—
        Logic_Safety["â›” å®‰å…¨ä¸è§„åˆ™è£å†³<br/>(Safety & Rules)"]:::logic
        Logic_Chase["ğŸƒ è¿½é€ç­–ç•¥<br/>(Visual Servo + PID)"]:::logic
        Logic_Defense["ğŸ›¡ï¸ é˜²å¾¡ç­–ç•¥<br/>(Blind Spin / Retreat)"]:::logic
        Logic_Game["ğŸ® æ¸¸æˆçŠ¶æ€ç®¡ç†<br/>(Win / Lose / HP)"]:::logic
    end

    %% -------------------
    %% äº¤äº’ä¸è¡¨ç°å±‚
    %% -------------------
    subgraph Output_Layer ["äº¤äº’è¡¨ç°å±‚ (Presentation Layer)"]
        Node_UI["ğŸ‘€ è¡¨æƒ…/å±å¹•æ¸²æŸ“<br/>(PyQt / PyGame)"]:::out
        Node_Audio["ğŸ”Š éŸ³æ•ˆæ’­æ”¾"]:::out
    end

    %% è¿çº¿å…³ç³»ï¼šç¡¬ä»¶ -> é©±åŠ¨
    HW_Cam ==> Node_Cam
    HW_UWB ==> Node_UWB
    HW_STM32 <==>|""| Node_Bridge

    %% è¿çº¿å…³ç³»ï¼šé©±åŠ¨ -> æ„ŸçŸ¥
    Node_Cam -->|Image Raw| Node_YOLO
    Node_Cam -->|Image Raw| Node_AprilTag
    Node_UWB -->|è·ç¦»æ•°æ® D_uwb| Node_Gating
    Node_Bridge -->|é‡Œç¨‹è®¡ & IMU| Node_Fusion
    Node_Bridge -->|"çº¢å¤–è§£ç äº‹ä»¶/RAW"| Node_IR_Filter

    %% è¿çº¿å…³ç³»ï¼šæ„ŸçŸ¥å†…éƒ¨æµè½¬
    Node_YOLO -->|"æ‰€æœ‰æ£€æµ‹æ¡† D_vis"| Node_Gating
    Node_Gating -->|"é”å®šç›®æ ‡ ID"| Node_Fusion
    
    %% è¿çº¿å…³ç³»ï¼šæ„ŸçŸ¥ -> å†³ç­–
    Node_Gating -->|"ç›®æ ‡åå·® Error_x"| Node_BT
    Node_AprilTag -->|"å¢™å£è·ç¦» D_tag"| Logic_Safety
    Node_Fusion -->|"æœºå™¨äººèåˆä½å§¿"| Node_BT
    Node_IR_Filter -->|"æœ‰æ•ˆå‘½ä¸­ (Hit)"| Logic_Game

    %% è¿çº¿å…³ç³»ï¼šå†³ç­–å†…éƒ¨
    Logic_Safety -->|"å¼ºåˆ¶æ¥ç®¡/æš‚åœ"| Node_BT
    Node_BT <--> Logic_Chase
    Node_BT <--> Logic_Defense
    Node_BT <--> Logic_Game

    %% è¿çº¿å…³ç³»ï¼šå†³ç­– -> è¾“å‡º/æ‰§è¡Œ
    Logic_Chase -->|"cmd_vel (PIDé€Ÿåº¦)"| Node_Bridge
    Logic_Defense -->|"cmd_vel (åº•ç›˜è¿æ¥)"| Node_Bridge
    Logic_Safety -->|"æ€¥åœ/è¾¹ç•Œé™åˆ¶"| Node_Bridge
    Logic_Game -->|"è¡€é‡/ç¯æ•ˆæŒ‡ä»¤"| Node_Bridge
    Logic_Game -->|"è¡¨æƒ…çŠ¶æ€"| Node_UI
    Logic_Game -->|"éŸ³æ•ˆè§¦å‘"| Node_Audio

            `,
            'algorithm': `
graph TD
    Start(("å¼€å§‹å¾ªç¯")) --> Init["åˆå§‹åŒ–: <br/>Score=0 <br/>é˜ˆå€¼ Threshold=20 <br/>ä¸Šé™ Max=80 <br/>è¡°å‡ Decay=25"]
    
    subgraph Time_Loop ["ä¸»å¾ªç¯ 10Hz (100ms)"]
        Check_IR{"æ£€æµ‹åˆ°æœ‰æ•ˆNECä¿¡å·?"}
        
        Check_IR -- Yes --> Add_Score["ç§¯åˆ†å¿«é€Ÿå¢åŠ : <br/> Score += 30 (ç¬é—´é”å®š)"]
        Check_IR -- No --> Do_Nothing["ä¿æŒ"]
        
        Add_Score --> Clamp_Max["é™åˆ¶ä¸Šé™: <br/> Score = min(Score, 80)"]
        Do_Nothing --> Clamp_Max
        
        Clamp_Max --> Decr_Score["è‡ªç„¶è¡°å‡ (å¿«é€Ÿé‡Šæ”¾): <br/> Score -= 25"]
        Decr_Score --> Clamp_Min["é™åˆ¶ä¸‹é™: <br/> Score = max(Score, 0)"]
        
        Clamp_Min --> Check_State{"Score > Threshold?"}
        
        Check_State -- Yes --> State_Aiming["çŠ¶æ€: è¢«ç„å‡†ä¸­ <br/> Aiming = True"]
        Check_State -- No --> State_Safe["çŠ¶æ€: å®‰å…¨ <br/> Aiming = False"]
    end

    subgraph Attack_Check ["æ”»å‡»åˆ¤å®šé€»è¾‘"]
        Signal_Type{"æ”¶åˆ°çš„NECç å†…å®¹?"}
        Signal_Type -- "Attack Code (æŒ‰ä¸‹)" --> Check_Aiming{"å½“å‰ Aiming == True?"}
        Signal_Type -- "Aim Code (å¸¸æ€)" --> Ignore["ä»…ç»´æŒç§¯åˆ†"]
        
        Check_Aiming -- Yes --> Event_Hit["è§¦å‘: æœ‰æ•ˆå‡»ä¸­! <br/> æ‰£è¡€ / å—ä¼¤åŠ¨ä½œ"]
        Check_Aiming -- No --> Event_Miss["å¿½ç•¥: ç›²å°„/å¹²æ‰°"]
    end

    State_Aiming -.-> Signal_Type
    
    style State_Aiming fill:#fbbf24,stroke:#b45309
    style Event_Hit fill:#ef4444,stroke:#991b1b,color:white
    style Add_Score fill:#86efac,stroke:#166534
    style Decr_Score fill:#fca5a5,stroke:#991b1b
    style Init fill:#e0e7ff,stroke:#4338ca
            `,
            'fsm': `
stateDiagram-v2
    direction TB
    
    [*] --> Idle
    note right of Idle: å¼€æœº/å¾…æœº
    
    state "Idle (å¾…æœº)" as Idle
    state "Scanning (ç´¢æ•Œ)" as Scanning
    
    state "Chase Mode (è¿½é€)" as Chase {
        state "Greedy (ç›´çº¿åŠ é€Ÿ)" as Chase_Greedy
        state "ZigZag (è›‡å½¢èµ°ä½)" as Chase_ZigZag
        note right of Chase_Greedy: è§†è§‰ä¼ºæœ PID æ§åˆ¶
        note right of Chase_ZigZag: å…¨å‘è½® Sin æ³¢é—ªé¿
        
        [*] --> Chase_Greedy
        Chase_Greedy --> Chase_ZigZag: è·ç¦» < 2m
        Chase_ZigZag --> Chase_Greedy: è·ç¦» > 2.5m
    }

    state "Defense Mode (é˜²å¾¡/ç›²æ“)" as Defense {
        state "Spin_180 (è½¬èº«)" as Spin
        state "Butt_Wiggle (å˜²è®½/å€’è½¦)" as Blind_Move
        state "Re_Acquire (å›èº«ç´¢æ•Œ)" as Reset
        note right of Blind_Move: IMU é”èˆªå‘ + å€’è½¦
        
        [*] --> Spin
        Spin --> Blind_Move: å®Œæˆ180åº¦
        Blind_Move --> Reset: è®¡æ—¶ç»“æŸ(3s) æˆ– æ’å¢™é¢„è­¦
    }

    state "Out_Of_Bounds (å‡ºç•Œæš‚åœ)" as OutOfBounds {
        state "Pause (åŸåœ°åœæ­¢)" as Pause
        state "Invincible (æ— æ•Œæ¨¡å¼)" as Invincible
        note right of Invincible: å¿½ç•¥çº¢å¤–ä¿¡å·
    }

    state "Impact (å—ä¼¤)" as Hurt {
        state "Stunned (æ™•çœ©)" as Stunned
        state "Rampage (æš´èµ°)" as Rampage
        
        [*] --> Stunned
        Stunned --> Rampage: 3sæ— æ•Œ
    }

    state "Win (æœºå™¨äººèƒœ)" as Win
    state "Lose (ç©å®¶èƒœ)" as Lose

    %% è¿æ¥å…³ç³»ä¿®æ­£
    Idle --> Scanning: å‘ç°ç›®æ ‡ (YOLO)
    Scanning --> Chase: ç›®æ ‡é”å®š & è·ç¦» > 2m

    Chase --> Defense: è·ç¦» < 1m
    Defense --> Chase: é‡æ–°å‘ç°ç›®æ ‡
    
    %% å‡ºç•Œåˆ¤å®šé€»è¾‘
    Chase --> OutOfBounds: å¢™å£è·ç¦»<0.5m & ç©å®¶>2m
    Defense --> OutOfBounds: å¢™å£è·ç¦»<0.5m & ç©å®¶>2m
    OutOfBounds --> Idle: ç©å®¶å›åˆ°ç•Œå†… (UWBå˜å°)

    Chase --> Win: UWBè·ç¦» < 0.5m
    Defense --> Win: UWBè·ç¦» < 0.5m
    
    Chase --> Hurt: IRè¢«å‡»ä¸­
    Defense --> Hurt: IRè¢«å‡»ä¸­
    
    Hurt --> Chase: æ— æ•Œç»“æŸ
    Hurt --> Lose: è¡€é‡ <= 0

    Win --> [*]
    Lose --> [*]
            `
        };

        const titles = {
            'hardware': 'ç¡¬ä»¶æ‹“æ‰‘ç»“æ„å›¾',
            'software': 'ROS 2 è½¯ä»¶æ¶æ„å›¾',
            'algorithm': 'çº¢å¤–ç„å‡†ä¼˜åŒ–ç®—æ³• (Fast Response)',
            'fsm': 'æ¸¸æˆè¡Œä¸ºçŠ¶æ€æœº'
        };

        let panzoomInstances = {};
        let activeTab = 'hardware';
        let editorVisible = false;
        let aiVisible = false;
        let debounceTimer = null;

        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'base',
            flowchart: { curve: 'linear' }, 
            maxTextSize: 999999,
            themeVariables: {
                fontFamily: 'Inter, sans-serif',
                primaryColor: '#e0e7ff',
                primaryTextColor: '#1e1b4b',
                primaryBorderColor: '#4338ca',
                lineColor: '#6366f1',
                secondaryColor: '#fef3c7',
                tertiaryColor: '#fff'
            }
        });

        async function renderDiagram(id, codeOverride = null) {
            const container = document.getElementById(id);
            const code = codeOverride || diagrams[id];
            const loading = document.getElementById('loading');
            
            if(!codeOverride) loading.style.opacity = '1';

            try {
                if (panzoomInstances[id]) {
                     // Remove manual wheel listener
                    container.parentElement.removeEventListener('wheel', panzoomInstances[id].zoomWithWheel);

                    // Call library cleanup
                    if (typeof panzoomInstances[id].destroy === 'function') {
                        panzoomInstances[id].destroy();
                    } else if (typeof panzoomInstances[id].dispose === 'function') {
                        panzoomInstances[id].dispose();
                    }
                    
                    delete panzoomInstances[id];
                }
                container.innerHTML = '';

                const svgId = `mermaid-svg-${id}-${Date.now()}`;
                const { svg } = await mermaid.render(svgId, code);
                
                container.innerHTML = svg;
                
                const svgElement = container.querySelector('svg');
                if (svgElement) {
                    svgElement.style.maxWidth = 'none';
                    svgElement.style.height = 'auto';
                    svgElement.setAttribute('height', '100%'); 

                    const instance = Panzoom(container, {
                        maxScale: 10,
                        minScale: 0.1,
                        contain: false,
                        startScale: 1
                    });
                    
                    container.parentElement.addEventListener('wheel', instance.zoomWithWheel);
                    panzoomInstances[id] = instance;

                    setTimeout(() => fitToScreen(id), 100);
                }
                
                // æ›´æ–°ç¼–è¾‘å™¨çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if(document.getElementById('editor-status')) {
                   document.getElementById('editor-status').textContent = 'æ¸²æŸ“æˆåŠŸ ' + new Date().toLocaleTimeString();
                   document.getElementById('editor-status').className = 'text-green-600';
                }

            } catch (error) {
                console.error("Mermaid Render Error:", error);
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-500 p-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p class="font-bold">æ¸²æŸ“å¤±è´¥</p>
                        <pre class="text-xs bg-red-50 p-2 mt-2 rounded border border-red-100 max-w-full overflow-auto">${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.style.opacity = '0';
            }
        }

        function fitToScreen(id) {
            const instance = panzoomInstances[id];
            const container = document.getElementById(id);
            const svg = container.querySelector('svg');
            if (!instance || !svg) return;

            const containerRect = container.getBoundingClientRect();
            let contentW, contentH;
            try {
                const bbox = svg.getBBox();
                contentW = bbox.width || 1000;
                contentH = bbox.height || 1000;
            } catch(e) {
                contentW = svg.viewBox?.baseVal?.width || 1000;
                contentH = svg.viewBox?.baseVal?.height || 1000;
            }
            
            const scaleX = (containerRect.width / contentW) * 0.85;
            const scaleY = (containerRect.height / contentH) * 0.85;
            const newScale = Math.min(scaleX, scaleY, 1.5); 
            
            instance.zoom(newScale, { animate: true });
            const offsetX = (containerRect.width - contentW * newScale) / 2;
            const offsetY = (containerRect.height - contentH * newScale) / 2;
            instance.pan(offsetX, offsetY, { animate: true });
            updateZoomLevel(id);
        }

        // é¢æ¿æ§åˆ¶
        const editorPanel = document.getElementById('editor-panel');
        const aiPanel = document.getElementById('ai-panel');
        const codeEditor = document.getElementById('code-editor');
        const btnEditToggle = document.getElementById('btn-edit-toggle');
        const btnAiToggle = document.getElementById('btn-ai-toggle');

        function toggleEditor() {
            editorVisible = !editorVisible;
            if (editorVisible) {
                // å…³é—­AIé¢æ¿
                if(aiVisible) toggleAI();
                
                editorPanel.classList.remove('panel-hidden');
                btnEditToggle.classList.add('bg-indigo-50', 'border-indigo-500', 'text-indigo-600');
                codeEditor.value = diagrams[activeTab];
            } else {
                editorPanel.classList.add('panel-hidden');
                btnEditToggle.classList.remove('bg-indigo-50', 'border-indigo-500', 'text-indigo-600');
            }
        }

        function toggleAI() {
            aiVisible = !aiVisible;
            if (aiVisible) {
                // å…³é—­ç¼–è¾‘å™¨
                if(editorVisible) toggleEditor();

                aiPanel.classList.remove('panel-hidden');
                btnAiToggle.classList.add('ring-2', 'ring-offset-1', 'ring-violet-500');
            } else {
                aiPanel.classList.add('panel-hidden');
                btnAiToggle.classList.remove('ring-2', 'ring-offset-1', 'ring-violet-500');
            }
        }

        // ç¼–è¾‘å™¨äº‹ä»¶
        codeEditor.addEventListener('input', (e) => {
            const newCode = e.target.value;
            diagrams[activeTab] = newCode;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { renderDiagram(activeTab, newCode); }, 800);
        });

        // Gemini AI é€»è¾‘
        async function callGemini(prompt, includeContext = true) {
            const chatHistory = document.getElementById('chat-history');
            const btnSend = document.getElementById('btn-send');
            const inputField = document.getElementById('ai-input');
            
            // UI: æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', prompt);
            
            // é”å®šè¾“å…¥
            btnSend.disabled = true;
            inputField.value = '';
            
            // UI: æ·»åŠ æ€è€ƒä¸­åŠ¨ç”»
            const loadingId = appendLoading();
            scrollToBottom();

            // æ„å»º Prompt
            let finalPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æœºå™¨äººè½¯ä»¶æ¶æ„å¸ˆï¼Œæ­£åœ¨ååŠ©ç”¨æˆ·è®¾è®¡ä¸€ä¸ªåä¸º "iGarden" çš„åº­é™¢æœºå™¨äººã€‚
å½“å‰æ­£åœ¨æŸ¥çœ‹çš„å›¾è¡¨æ˜¯ï¼š${titles[activeTab]}ã€‚
`;
            if (includeContext) {
                finalPrompt += `
å½“å‰çš„ Mermaid æºç å¦‚ä¸‹ï¼š
\`\`\`mermaid
${diagrams[activeTab]}
\`\`\`
è¯·æ ¹æ®ä»¥ä¸Šä»£ç å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœç”¨æˆ·è¦æ±‚ä¿®æ”¹æˆ–ç”Ÿæˆä»£ç ï¼Œè¯·åªè¿”å› Markdown æ ¼å¼çš„ Mermaid ä»£ç å—ã€‚
ç”¨æˆ·çš„éœ€æ±‚æ˜¯ï¼š${prompt}`;
            } else {
                finalPrompt += `ç”¨æˆ·çš„éœ€æ±‚æ˜¯ï¼š${prompt}`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: finalPrompt }] }]
                    })
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘å¥½åƒæ–­çº¿äº†ï¼Œè¯·é‡è¯•ã€‚";
                
                // ç§»é™¤ loading
                document.getElementById(loadingId).remove();
                
                // UI: æ˜¾ç¤º AI å›å¤
                appendMessage('ai', aiText);

            } catch (error) {
                console.error("Gemini API Error:", error);
                document.getElementById(loadingId).remove();
                appendMessage('ai', "ç½‘ç»œè¿æ¥å‡ºé”™ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œè®¾ç½®ã€‚");
            } finally {
                btnSend.disabled = false;
                scrollToBottom();
            }
        }

        function appendMessage(role, text) {
            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-bubble chat-${role}`;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ Mermaid ä»£ç å—
            const codeBlockRegex = /```mermaid([\s\S]*?)```/g;
            const match = codeBlockRegex.exec(text);
            
            if (match) {
                const code = match[1].trim();
                // æ¸²æŸ“ Markdown æ–‡æœ¬éƒ¨åˆ† (ç§»é™¤ä»£ç å—å)
                const cleanText = text.replace(codeBlockRegex, '');
                div.innerHTML = marked.parse(cleanText);
                
                // æ·»åŠ ä»£ç é¢„è§ˆå’Œåº”ç”¨æŒ‰é’®
                const codePreview = document.createElement('div');
                codePreview.className = "mt-2 bg-slate-800 rounded-lg p-3";
                codePreview.innerHTML = `
                    <div class="flex justify-between items-center mb-2 text-xs text-slate-400">
                        <span><i class="fas fa-code"></i> ç”Ÿæˆçš„ä»£ç </span>
                        <button onclick="applyCodeFromAI(this)" class="px-2 py-1 bg-emerald-600 text-white rounded hover:bg-emerald-500 transition">
                            <i class="fas fa-check"></i> åº”ç”¨åˆ°ç”»å¸ƒ
                        </button>
                    </div>
                    <pre class="text-xs text-emerald-300 font-mono overflow-x-auto custom-scrollbar">${escapeHtml(code)}</pre>
                    <textarea class="hidden code-storage">${code}</textarea>
                `;
                div.appendChild(codePreview);
            } else {
                div.innerHTML = marked.parse(text);
            }
            
            chatHistory.appendChild(div);
        }

        function appendLoading() {
            const chatHistory = document.getElementById('chat-history');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `chat-bubble chat-ai`;
            div.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            chatHistory.appendChild(div);
            return id;
        }

        function sendMessage() {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if (text) callGemini(text);
        }

        function sendQuickAction(type) {
            if (type === 'explain') {
                callGemini("è¯·åƒèµ„æ·±æ¶æ„å¸ˆä¸€æ ·ï¼Œç®€æ˜æ‰¼è¦åœ°è§£è¯»å½“å‰è¿™å¼ æ¶æ„å›¾çš„è®¾è®¡é€»è¾‘å’Œæ•°æ®æµå‘ã€‚");
            } else if (type === 'optimize') {
                callGemini("è¯·åˆ†æå½“å‰çš„ Mermaid ä»£ç ï¼Œåœ¨ä¿æŒé€»è¾‘ä¸å˜çš„å‰æä¸‹ï¼Œä¼˜åŒ–å¸ƒå±€æ–¹å‘æˆ–èŠ‚ç‚¹åˆ†ç»„ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´æ¸…æ™°ä¸“ä¸šã€‚è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„ Mermaid ä»£ç ã€‚");
            }
        }

        function handleInputKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function applyCodeFromAI(btn) {
            const code = btn.parentElement.parentElement.querySelector('.code-storage').value;
            diagrams[activeTab] = code;
            renderDiagram(activeTab);
            
            // å¦‚æœç¼–è¾‘å™¨å¼€ç€ï¼Œä¹Ÿæ›´æ–°ç¼–è¾‘å™¨
            if(editorVisible) {
                document.getElementById('code-editor').value = code;
            }
            
            // åé¦ˆåŠ¨ç”»
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-check-circle"></i> å·²åº”ç”¨`;
            btn.classList.replace('bg-emerald-600', 'bg-slate-600');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.replace('bg-slate-600', 'bg-emerald-600');
            }, 2000);
        }

        function scrollToBottom() {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Tab åˆ‡æ¢é€»è¾‘
        async function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'border-indigo-500', 'text-white');
                btn.classList.add('text-slate-400', 'border-transparent');
            });
            document.getElementById(`btn-${tabId}`).classList.add('bg-slate-800', 'border-indigo-500', 'text-white');
            document.getElementById(`btn-${tabId}`).classList.remove('text-slate-400', 'border-transparent');
            document.getElementById('header-title').textContent = titles[tabId];
            
            Object.keys(diagrams).forEach(key => {
                document.getElementById(key).classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            
            activeTab = tabId;

            if (editorVisible) codeEditor.value = diagrams[activeTab];

            if (!panzoomInstances[tabId]) {
                await renderDiagram(tabId);
            } else {
                updateZoomLevel(tabId);
            }
        }

        function zoomIn() { panzoomInstances[activeTab]?.zoomIn(); updateZoomLevel(activeTab); }
        function zoomOut() { panzoomInstances[activeTab]?.zoomOut(); updateZoomLevel(activeTab); }
        function resetView() { fitToScreen(activeTab); }
        function updateZoomLevel(id) {
            const scale = panzoomInstances[id]?.getScale();
            if(scale) document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
        }

        window.addEventListener('load', () => switchTab('hardware'));
        window.addEventListener('resize', () => fitToScreen(activeTab));
    </script>
</body>
</html>
